#!/usr/bin/env python3
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os
import xgboost as xgb
from joblib import load
from dcurves import dca
from sklearn.base import BaseEstimator, TransformerMixin

class PostProcessingImputer(BaseEstimator, TransformerMixin):
    def __init__(self):
        self.lab_prefixes_ = ['df_bili', 'df_crea', 'df_plate']
    def fit(self, X, y=None): return self
    def transform(self, X):
        X = X.copy()
        for pref in self.lab_prefixes_:
            last, first, diff = f"{pref}_Lab Result of Last Timepoint", f"{pref}_Lab Result of First Timepoint", f"{pref}_Last - First"
            if all(c in X.columns for c in [last, first, diff]):
                mask = X[last].isna() & X[first].notna() & X[diff].notna()
                X.loc[mask, last] = X.loc[mask, first] + X.loc[mask, diff]
        return X

CONFIG = {
    "28d":   {"target": "Mortality_28day", "name": "28-Day Mortality",   "models": {"xgb": "all_final_model/xgb_fs/xgb_fs_28d_noweight.joblib", "rf": "all_final_model/rf/FS_28d.joblib", "mlp": "all_final_model/mlp/mlp_28d_final.joblib"}},
    "90d":   {"target": "Mortality_90day", "name": "90-Day Mortality",   "models": {"xgb": "all_final_model/xgb_fs/xgb_fs_90d_noweight.joblib", "rf": "all_final_model/rf/FS_90d.joblib", "mlp": "all_final_model/mlp/mlp_90d_final.joblib"}},
    "1year": {"target": "Mortality_1year", "name": "1-Year Mortality",   "models": {"xgb": "all_final_model/xgb_fs/xgb_fs_1y_noweight.joblib",   "rf": "all_final_model/rf/FS_1y.joblib",  "mlp": "all_final_model/mlp/mlp_1y_final.joblib"}}
}

STYLES = {
    "xgb": {"color": "blue",  "label": "XGBoost"},
    "rf":  {"color": "green", "label": "Random Forest"},
    "mlp": {"color": "red",   "label": "MLP"}
}

TEST_DATA_PATH = "datasets/train_test_202511_80/test.csv"

def get_model_features(model, X_test):
    if hasattr(model, "named_steps") and 'final_prep' in model.named_steps:
        if hasattr(model.named_steps['final_prep'], 'get_feature_names_out'):
            return list(model.named_steps['final_prep'].get_feature_names_out())
    if hasattr(model, "feature_names_in_"): return list(model.feature_names_in_)
    if hasattr(model, "get_booster") and hasattr(model.get_booster(), "feature_names"):
        return model.get_booster().feature_names
    return list(X_test.columns)

def get_probs(model, X):
    if hasattr(model, "predict_proba"): return model.predict_proba(X)[:, 1]
    if isinstance(model, xgb.Booster): return model.predict(xgb.DMatrix(X))
    raise ValueError("Model does not support probability predictions")

def main():
    save_dir = "brier/decision_curves_simple"
    os.makedirs(save_dir, exist_ok=True)
    
    df_test = pd.read_csv(TEST_DATA_PATH)
    thresholds = np.arange(0, 0.81, 0.01)

    fig, axes = plt.subplots(1, 3, figsize=(18, 5))

    for ax, (key, cfg) in zip(axes, CONFIG.items()):
        print(f"Processing {cfg['name']}...")
        
        dca_df = pd.DataFrame({cfg["target"]: df_test[cfg["target"]]})
        model_cols = []

        for model_key, path in cfg["models"].items():
            model = load(path)
            feats = get_model_features(model, df_test)
            
            col_name = f"prob_{model_key}"
            dca_df[col_name] = get_probs(model, df_test[feats])
            model_cols.append(col_name)

        results = dca(
            data=dca_df, 
            outcome=cfg["target"], 
            modelnames=model_cols, 
            thresholds=thresholds.tolist()
        )

        ax.plot(results[results.model=='all'].threshold, results[results.model=='all'].net_benefit, 'k--', label='Treat all', alpha=0.7)
        ax.plot(results[results.model=='none'].threshold, results[results.model=='none'].net_benefit, 'k:', label='Treat none', alpha=0.7)

        for col_name in model_cols:
            model_type = col_name.replace("prob_", "")
            subset = results[results.model == col_name]
            ax.plot(subset.threshold, subset.net_benefit, 
                    color=STYLES[model_type]["color"], label=STYLES[model_type]["label"], linewidth=2)

        ax.set_title(cfg["name"], fontweight='bold')
        ax.set_xlabel('Threshold Probability')
        ax.set_xlim(0, 0.8)
        ax.set_ylim(-0.05, None)
        if key == "28d": ax.set_ylabel('Net Benefit')
        if key == "1year": ax.legend(loc='upper right')

    plt.tight_layout()
    save_path = os.path.join(save_dir, "dca_combined.png")
    plt.savefig(save_path, dpi=300)
    print(f"Done! Plot saved to: {save_path}")

if __name__ == "__main__":
    main()
